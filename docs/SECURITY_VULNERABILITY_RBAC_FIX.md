# üî¥ CRITICAL SECURITY VULNERABILITY: RBAC Fix Required

**Discovered:** October 7, 2025
**Severity:** CRITICAL
**Status:** REQUIRES IMMEDIATE FIX

## Vulnerability Summary

**Problem:** Kiosk devices can access ALL admin endpoints (students, schools, buses, parents CRUD operations) because they pass `IsAuthenticated` permission check.

**Risk:** Compromised kiosk could:
- Delete all students from database
- Create fake schools
- Modify bus assignments
- Access parent contact information
- Disable other kiosks

## Current Broken Architecture

```
Backend OpenAPI Schema ‚Üí Generates ALL 62 endpoints ‚Üí Frontend gets client with ALL methods
                                                        ‚Üì
                                              Kiosk JWT token passes `IsAuthenticated`
                                                        ‚Üì
                                              üî¥ Kiosk can call ANY API method!
```

## Industry Standard: Role-Based Access Control (RBAC)

### Fortune 500 Pattern (AWS, Stripe, Google):

1. **Authentication** (who you are) ‚úÖ You have this
   - Kiosk authenticates with kiosk_id + api_key
   - Gets JWT token with `type: 'kiosk'`

2. **Authorization** (what you can do) ‚ùå YOU'RE MISSING THIS!
   - Token should contain **role/permissions**
   - Endpoints check **role-specific permissions**
   - Kiosks should only access kiosk-scoped endpoints

### Required Fixes

## Fix 1: Update JWT Token to Include Role

**File:** `backend_easy/app/kiosks/views.py`

**Current (Line 95):**
```python
refresh = RefreshToken()
refresh['kiosk_id'] = kiosk.kiosk_id
refresh['type'] = 'kiosk'  # Token type for permission checking
```

**Should be:**
```python
refresh = RefreshToken()
refresh['kiosk_id'] = kiosk.kiosk_id
refresh['type'] = 'kiosk'
refresh['role'] = 'kiosk'  # Add role claim
refresh['permissions'] = ['sync:read', 'sync:write', 'boarding:create']  # Explicit permissions
```

## Fix 2: Create Kiosk-Only Permission Class

**File:** `backend_easy/app/bus_kiosk_backend/permissions.py`

**Add new permission:**
```python
class IsNotKiosk(BasePermission):
    """
    Permission that denies access to kiosk devices.

    Use this on admin endpoints (students, buses, schools, parents)
    to prevent kiosks from accessing them.
    """

    def has_permission(self, request, view):
        # Must be authenticated
        if not request.user or not request.user.is_authenticated:
            return False

        # Deny if user is a Kiosk object (from KioskJWTAuthentication)
        if hasattr(request.user, 'kiosk_id'):
            return False  # üîí Block kiosks!

        # Check if JWT token has role='kiosk'
        if hasattr(request, 'auth') and request.auth:
            token_type = request.auth.get('type')
            if token_type == 'kiosk':
                return False  # üîí Block kiosks!

        # Allow web/mobile users
        return True
```

## Fix 3: Update Student ViewSet Permissions

**File:** `backend_easy/app/students/views.py`

**Current (Line 33):**
```python
class StudentViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]  # üî¥ INSECURE!
```

**Should be:**
```python
from bus_kiosk_backend.permissions import IsSchoolAdmin, IsNotKiosk

class StudentViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated, IsNotKiosk]  # üîí Block kiosks!

    def get_permissions(self):
        # Read-only for authenticated non-kiosk users
        if self.action in ['list', 'retrieve']:
            return [IsAuthenticated(), IsNotKiosk()]

        # Write operations require school admin
        if self.action in ['create', 'update', 'partial_update', 'destroy']:
            return [IsSchoolAdmin()]

        return [IsAuthenticated(), IsNotKiosk()]
```

## Fix 4: Secure All Admin Endpoints

**Apply to:**
- `students/views.py` ‚Üí SchoolViewSet, BusViewSet, StudentViewSet, ParentViewSet, StudentParentViewSet, StudentPhotoViewSet
- `buses/views.py` ‚Üí BusViewSet, RouteViewSet
- `kiosks/views.py` ‚Üí KioskViewSet, DeviceLogViewSet

**Pattern:**
```python
class AdminResourceViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated, IsNotKiosk]  # üîí Block kiosks!

    def get_permissions(self):
        # Fine-grained control per action
        if self.action in ['create', 'update', 'destroy']:
            return [IsSchoolAdmin()]  # Write = Admin only
        return [IsAuthenticated(), IsNotKiosk()]  # Read = Any authenticated user (not kiosk)
```

## Fix 5: Verify Kiosk Can Only Access Kiosk Endpoints

**Kiosk-allowed endpoints (keep `IsKiosk` permission):**
- ‚úÖ `/api/v1/auth/` (AllowAny)
- ‚úÖ `/api/v1/{kiosk_id}/check-updates/` (IsKiosk)
- ‚úÖ `/api/v1/{kiosk_id}/snapshot/` (IsKiosk)
- ‚úÖ `/api/v1/{kiosk_id}/heartbeat/` (IsKiosk)
- ‚úÖ `/api/v1/boarding-events/` (IsKiosk) - when implemented
- ‚úÖ `/api/v1/logs/` (IsKiosk) - when implemented

**Kiosk-blocked endpoints (add `IsNotKiosk`):**
- üîí ALL `/api/v1/students/*`
- üîí ALL `/api/v1/schools/*`
- üîí ALL `/api/v1/buses/*`
- üîí ALL `/api/v1/routes/*`
- üîí ALL `/api/v1/parents/*`
- üîí `/api/v1/kiosks/*` (management endpoints)

## Testing the Fix

### Test 1: Kiosk Should Be Blocked
```bash
# Authenticate as kiosk
curl -X POST http://localhost:8000/api/v1/auth/ \
  -H "Content-Type: application/json" \
  -d '{"kiosk_id": "TEST-KIOSK-001", "api_key": "test-api-key"}'

# Try to list students (should return 403 Forbidden)
curl -X GET http://localhost:8000/api/v1/students/ \
  -H "Authorization: Bearer <kiosk_jwt_token>"

# Expected: {"detail": "You do not have permission to perform this action."}
```

### Test 2: Kiosk Should Access Sync Endpoints
```bash
# Check updates (should work)
curl -X GET http://localhost:8000/api/v1/TEST-KIOSK-001/check-updates/?last_sync=2024-01-01T00:00:00Z \
  -H "Authorization: Bearer <kiosk_jwt_token>"

# Expected: {"needs_update": true, "current_version": "...", ...}
```

### Test 3: Admin User Should Access Everything
```bash
# Authenticate as admin user
curl -X POST http://localhost:8000/api/v1/token/ \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'

# List students (should work)
curl -X GET http://localhost:8000/api/v1/students/ \
  -H "Authorization: Bearer <admin_jwt_token>"

# Expected: [{"student_id": "...", "name": "...", ...}, ...]
```

## Architecture After Fix

```
Backend OpenAPI Schema ‚Üí Generates ALL 62 endpoints ‚Üí Frontend gets client with ALL methods
                                                        ‚Üì
                                              Kiosk JWT token (role='kiosk')
                                                        ‚Üì
                                              IsNotKiosk permission checks role
                                                        ‚Üì
                                              üîí 403 Forbidden for admin endpoints
                                              ‚úÖ 200 OK for kiosk endpoints (sync, boarding)
```

## Industry Comparison

| Company | Pattern | Your Current | Your Target |
|---------|---------|--------------|-------------|
| **AWS** | IAM roles with explicit permissions | ‚ùå Missing | ‚úÖ RBAC |
| **Stripe** | API keys scoped to resources | ‚ùå Missing | ‚úÖ RBAC |
| **Google** | Service accounts with role bindings | ‚ùå Missing | ‚úÖ RBAC |
| **GitHub** | Token scopes (read:repo, write:repo) | ‚ùå Missing | ‚úÖ RBAC |

## Constitutional Compliance

This fix aligns with **ZERO SECURITY DRIFT** constitutional principle:
- **Principle of Least Privilege**: Kiosks should only access what they need
- **Defense in Depth**: Multiple layers (authentication + authorization)
- **Explicit Permissions**: No implicit access to admin endpoints

## Next Steps

1. **IMMEDIATE:** Implement `IsNotKiosk` permission class
2. **IMMEDIATE:** Update all admin ViewSets to use `IsNotKiosk`
3. **IMMEDIATE:** Test kiosk cannot access student/school/bus endpoints
4. **FOLLOW-UP:** Add role claims to JWT tokens
5. **FOLLOW-UP:** Audit all endpoints for proper permission classes
6. **FOLLOW-UP:** Document security model in README

## References

- [Django REST Framework Permissions](https://www.django-rest-framework.org/api-guide/permissions/)
- [JWT Best Practices](https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-token-best-practices)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
- [Principle of Least Privilege](https://en.wikipedia.org/wiki/Principle_of_least_privilege)
