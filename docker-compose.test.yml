# Docker Compose for CI Testing
# Contains only the services needed for running tests in CI

services:
  # PostgreSQL Database for Testing
  postgres:
    image: postgres:15
    container_name: test_postgres
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: test_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test_network

  # Redis for Testing
  redis:
    image: redis:7
    container_name: test_redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test_network

  # Web service - Tests pre-built Docker image (no volumes in CI)
  web:
    image: backend_easy:test
    container_name: test_web
    command: daphne -b 0.0.0.0 -p 8000 bus_kiosk_backend.asgi:application
    environment:
      DEBUG: 'true'
      SECRET_KEY: test-secret-key-for-testing-only
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-test-encryption-key-32-bytes-long!}
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/test_db
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      USE_FILE_LOGGING: 'false'
      ALLOWED_HOSTS: '*'
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - test_network

  # Celery worker - Same image, different command
  celery_worker:
    image: backend_easy:test
    container_name: test_celery_worker
    command: celery -A bus_kiosk_backend worker --loglevel=info
    environment:
      DEBUG: 'true'
      SECRET_KEY: test-secret-key-for-testing-only
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-test-encryption-key-32-bytes-long!}
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/test_db
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      USE_FILE_LOGGING: 'false'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - test_network

networks:
  test_network:
    driver: bridge
