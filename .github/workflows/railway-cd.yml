name: Railway CD Pipeline

# ðŸš‚ Three-Station Railway Pattern:
# Station 1 (develop) â†’ Staging (auto-deploy, manual testing)
# Station 2 (master)  â†’ Candidate (auto-deploy, robot testing)
# Station 3 (tag)     â†’ Production (auto-deploy if Station 2 passed)

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [develop, master]
    types: [completed]
  push:
    tags:
      - 'v*'           # Production: v1.0.0, v2.1.3, etc.
      - 'hotfix-*'     # Emergency: hotfix-1.0.1

env:
  # GCP Configuration - Set these as GitHub Repository Variables (not secrets):
  # Go to: Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab
  #
  # Required Variables:
  # - GCP_PROJECT_ID = project-283878a7-633d-4014-a7f
  # - GCP_PROJECT_NUMBER = 683213759629
  # - GCP_SA_EMAIL = github-actions-sa@project-283878a7-633d-4014-a7f.iam.gserviceaccount.com
  # - GCP_REGION = asia-south1
  # - GAR_REPO = backend-repo

  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_PROJECT_NUMBER: ${{ vars.GCP_PROJECT_NUMBER }}
  GCP_SA_EMAIL: ${{ vars.GCP_SA_EMAIL }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  GAR_REPO: ${{ vars.GAR_REPO }}
  IMAGE_NAME: backend_easy

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  # ðŸš‚ STATION 1: STAGING

  staging-setup:
    name: "ðŸ“¦ Staging: Setup"
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'

    steps:
      - uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ github.event.workflow_run.head_branch }}-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Load and tag image
        run: |
          gunzip -c image.tar.gz | docker load
          docker tag ${{ env.IMAGE_NAME }}:${{ github.event.workflow_run.head_branch }} ${{ env.IMAGE_NAME }}:staging
          docker save ${{ env.IMAGE_NAME }}:staging | gzip > staging-image.tar.gz

      - name: Upload staged image
        uses: actions/upload-artifact@v4
        with:
          name: staging-image-${{ github.run_id }}
          path: staging-image.tar.gz
          retention-days: 1

  staging-push:
    name: "ðŸš€ Staging: Push to GAR"
    runs-on: ubuntu-latest
    needs: [staging-setup]

    steps:
      - uses: actions/checkout@v4

      - name: Download staged image
        uses: actions/download-artifact@v4
        with:
          name: staging-image-${{ github.run_id }}

      - name: Load image
        run: gunzip -c staging-image.tar.gz | docker load

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: ${{ env.GCP_SA_EMAIL }}

      - name: Push to Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

          GAR_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}"
          docker tag ${{ env.IMAGE_NAME }}:staging $GAR_IMAGE:staging
          docker push $GAR_IMAGE:staging

          echo "âœ… Image pushed to GAR: $GAR_IMAGE:staging" >> $GITHUB_STEP_SUMMARY

  staging-deploy:
    name: "ðŸš‚ Staging: Deploy to Cloud Run"
    runs-on: ubuntu-latest
    needs: [staging-push]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-cloud-run
        with:
          environment: staging
          service_name: backendeasy-staging
          image_tag: staging
          min_instances: 0
          max_instances: 10
          memory: 512Mi
          cpu: 1
          django_env: staging
          debug: True

  # ðŸš‚ STATION 2: CANDIDATE

  candidate-setup:
    name: "ðŸ“¦ Candidate: Setup"
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'master'

    steps:
      - uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ github.event.workflow_run.head_branch }}-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Load and tag image
        run: |
          gunzip -c image.tar.gz | docker load
          docker tag ${{ env.IMAGE_NAME }}:${{ github.event.workflow_run.head_branch }} ${{ env.IMAGE_NAME }}:candidate
          docker save ${{ env.IMAGE_NAME }}:candidate | gzip > candidate-image.tar.gz

      - name: Upload staged image
        uses: actions/upload-artifact@v4
        with:
          name: candidate-image-${{ github.run_id }}
          path: candidate-image.tar.gz
          retention-days: 1

  candidate-push:
    name: "ðŸš€ Candidate: Push to GAR"
    runs-on: ubuntu-latest
    needs: [candidate-setup]

    steps:
      - uses: actions/checkout@v4

      - name: Download staged image
        uses: actions/download-artifact@v4
        with:
          name: candidate-image-${{ github.run_id }}

      - name: Load image
        run: gunzip -c candidate-image.tar.gz | docker load

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: ${{ env.GCP_SA_EMAIL }}

      - name: Push to Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

          GAR_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}"
          docker tag ${{ env.IMAGE_NAME }}:candidate $GAR_IMAGE:candidate
          docker push $GAR_IMAGE:candidate

          echo "âœ… Image pushed to GAR: $GAR_IMAGE:candidate" >> $GITHUB_STEP_SUMMARY

  candidate-deploy:
    name: "ðŸš‚ Candidate: Deploy to Cloud Run"
    runs-on: ubuntu-latest
    needs: [candidate-push]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-cloud-run
        with:
          environment: candidate
          service_name: backendeasy-candidate
          image_tag: candidate
          min_instances: 0
          max_instances: 1
          memory: 512Mi
          cpu: 1
          django_env: staging
          debug: true

  candidate-test:
    name: "ðŸ¤– Candidate: Automated Tests"
    runs-on: ubuntu-latest
    needs: [candidate-deploy]

    outputs:
      passed: ${{ steps.health_check.outputs.passed }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: ${{ env.GCP_SA_EMAIL }}

      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Run health checks
        id: health_check
        run: |
          SERVICE_URL=$(gcloud run services describe backendeasy-candidate --region=${{ env.GCP_REGION }} --format='value(status.url)')

          echo "ðŸ¤– Running automated tests against: $SERVICE_URL"

          # Health check
          if ! curl -f -s "$SERVICE_URL/health/" > /dev/null; then
            echo "âŒ Health check failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "ðŸš¨ CANDIDATE FAILED: Health check" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… Health check passed"

          # API check
          if ! curl -f -s "$SERVICE_URL/api/v1/" > /dev/null; then
            echo "âŒ API check failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "ðŸš¨ CANDIDATE FAILED: API check" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… API check passed"

          echo "passed=true" >> $GITHUB_OUTPUT

          echo "ðŸš‚ Station 2: CANDIDATE READY âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All automated checks passed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy to production:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "git tag v1.0.0" >> $GITHUB_STEP_SUMMARY
          echo "git push --tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ðŸš‚ STATION 3: PRODUCTION

  production-deploy:
    name: "ðŸš‚ Production: Deploy"
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4

      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: ${{ env.GCP_SA_EMAIL }}

      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-cloud-run
        with:
          environment: production
          service_name: backendeasy
          image_tag: candidate
          min_instances: 1
          max_instances: 100
          memory: 1Gi
          cpu: 2
          django_env: production
          debug: False

      - name: Add production summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cloud Run auto-rollback enabled." >> $GITHUB_STEP_SUMMARY
