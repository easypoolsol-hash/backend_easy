name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
      artifact_name:
        description: 'Artifact name (e.g., docker-image-master-abc123)'
        required: true
        type: string
      image_tag:
        description: 'Image tag to deploy (e.g., master, sha-abc123)'
        required: true
        type: string
      confirm:
        description: 'Type environment name to confirm deployment'
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_PROJECT_NUMBER: ${{ vars.GCP_PROJECT_NUMBER }}
  GCP_SA_EMAIL: ${{ vars.GCP_SA_EMAIL }}
  GCP_REGION: ${{ vars.GCP_REGION || 'asia-south1' }}
  GAR_REPO: ${{ vars.GAR_REPO || 'backend-repo' }}
  IMAGE_NAME: backend_easy

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  # Validate confirmation input
  validate:
    name: Validate deployment confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "${{ github.event.inputs.environment }}" ]; then
            echo "âŒ Confirmation failed!"
            echo "Expected: '${{ github.event.inputs.environment }}'"
            echo "Got: '${{ github.event.inputs.confirm }}'"
            exit 1
          fi
          echo "âœ… Deployment confirmed for ${{ github.event.inputs.environment }}"

  # Push artifact to GAR
  push-to-gar:
    name: Push to GAR
    needs: validate
    uses: ./.github/workflows/push-to-gar.yml
    with:
      artifact_name: ${{ github.event.inputs.artifact_name }}
      image_tag: ${{ github.event.inputs.image_tag }}
      environment: ${{ github.event.inputs.environment }}

  # Deploy to Cloud Run
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: push-to-gar
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "CLOUD_RUN_SERVICE=backendeasy" >> $GITHUB_ENV
            echo "MIN_INSTANCES=1" >> $GITHUB_ENV
            echo "MAX_INSTANCES=100" >> $GITHUB_ENV
            echo "MEMORY=1Gi" >> $GITHUB_ENV
            echo "CPU=2" >> $GITHUB_ENV
            echo "SECRET_SUFFIX=" >> $GITHUB_ENV
          else
            echo "CLOUD_RUN_SERVICE=backendeasy-staging" >> $GITHUB_ENV
            echo "MIN_INSTANCES=0" >> $GITHUB_ENV
            echo "MAX_INSTANCES=10" >> $GITHUB_ENV
            echo "MEMORY=512Mi" >> $GITHUB_ENV
            echo "CPU=1" >> $GITHUB_ENV
            echo "SECRET_SUFFIX=-staging" >> $GITHUB_ENV
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "${{ env.GCP_SA_EMAIL }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify image exists in GAR
        run: |
          IMAGE_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"

          echo "Verifying image exists..."
          gcloud artifacts docker images describe $IMAGE_URL || {
            echo "âŒ Image not found: $IMAGE_URL"
            exit 1
          }

      - name: Deploy to Cloud Run
        run: |
          IMAGE_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"

          echo "ðŸš€ Deploying to ${{ github.event.inputs.environment }}..."
          echo "Service: ${{ env.CLOUD_RUN_SERVICE }}"
          echo "Image: $IMAGE_URL"

          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --image=$IMAGE_URL \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --min-instances=${{ env.MIN_INSTANCES }} \
            --max-instances=${{ env.MAX_INSTANCES }} \
            --memory=${{ env.MEMORY }} \
            --cpu=${{ env.CPU }} \
            --port=8000 \
            --set-env-vars="DJANGO_ENV=production" \
            --update-secrets="SECRET_KEY=django-secret-key${{ env.SECRET_SUFFIX }}:latest,ENCRYPTION_KEY=encryption-key${{ env.SECRET_SUFFIX }}:latest,DB_NAME=db-name${{ env.SECRET_SUFFIX }}:latest,DB_USER=db-user${{ env.SECRET_SUFFIX }}:latest,DB_PASSWORD=db-password${{ env.SECRET_SUFFIX }}:latest,DB_HOST=db-host${{ env.SECRET_SUFFIX }}:latest,REDIS_URL=redis-url${{ env.SECRET_SUFFIX }}:latest,CELERY_BROKER_URL=celery-broker-url${{ env.SECRET_SUFFIX }}:latest,GOOGLE_MAPS_API_KEY=google-maps-api-key:latest,FIREBASE_SERVICE_ACCOUNT_KEY_PATH=firebase-service-account-key-path:latest"

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')

          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** \`${{ env.CLOUD_RUN_SERVICE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ github.event.inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor at: $SERVICE_URL/health/" >> $GITHUB_STEP_SUMMARY

      - name: Send deployment notification
        if: success()
        run: |
          echo "âœ… ${{ github.event.inputs.environment }} deployment completed"
          echo "Image: ${{ github.event.inputs.image_tag }}"
          echo "Service: ${{ env.CLOUD_RUN_SERVICE }}"
