name: Manual Deploy & Fast-Lane

# ARCHITECTURE:
# =============
# 1. Manual Deploy: Deploy existing image from GCR (workflow_dispatch)
# 2. Fast-Lane Staging: Build & deploy to staging, skip tests (commit with "skip")
#
# CRITICAL: Fast-lane uses SEPARATE cache (gha-fastlane)
# - Main CI uses: type=gha (default)
# - Fast-lane uses: type=gha,scope=fastlane
# - This prevents master from loading untested fast-lane images

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - candidate
          - production
      image_tag:
        description: 'Image tag to deploy (staging, candidate, latest, or specific version)'
        required: true
        default: 'candidate'

  push:
    branches: [ develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'

permissions:
  id-token: write
  contents: read

env:
  IMAGE_NAME: backend_easy
  GCR_REGISTRY: asia-south1-docker.pkg.dev
  GCR_IMAGE: asia-south1-docker.pkg.dev/backend-easypool/backend-repo/backend_easy

jobs:
  # ============================================================================
  # MANUAL DEPLOY: Deploy existing image from GCR
  # ============================================================================
  deploy-manual:
    name: Deploy ${{ inputs.environment }}
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy to Cloud Run
        run: |
          # Map environment to service name
          case "${{ inputs.environment }}" in
            staging)
              SERVICE_NAME="easypool-backend-staging"
              ;;
            candidate)
              SERVICE_NAME="easypool-backend-candidate"
              ;;
            production)
              SERVICE_NAME="easypool-backend"
              ;;
          esac

          # Deploy with image tag
          gcloud run deploy $SERVICE_NAME \
            --image=${{ env.GCR_IMAGE }}:${{ inputs.image_tag }} \
            --region=asia-south1 \
            --platform=managed

          # Get service URL
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=asia-south1 --format='value(status.url)')

          echo "## Deployment Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Deployed using Terraform-managed configuration!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # FAST-LANE STAGING: Build & deploy quickly, skip tests (for small fixes)
  # ============================================================================
  # TRIGGERS: Commit message contains "skip" (e.g., "fix typo [skip]")
  # CACHE: Uses SEPARATE cache (scope=fastlane) so master NEVER loads it
  # WARNING: Skips tests - use only for trivial fixes
  # ============================================================================
  deploy-fast-staging:
    name: Fast-Lane Staging (skip tests)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/develop' &&
      contains(github.event.head_commit.message, 'skip')

    steps:
      - uses: actions/checkout@v4

      - name: Warning banner
        run: |
          echo "## âš ï¸ FAST-LANE DEPLOYMENT (Tests Skipped)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** develop" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** Staging only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Tests skipped** - use only for trivial fixes" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ **Isolated cache** - won't affect main CI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (SEPARATE fast-lane cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:fastlane-staging
          # CRITICAL: Separate cache scope so main CI never uses it
          cache-from: type=gha,scope=fastlane
          cache-to: type=gha,scope=fastlane,mode=max

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker ${{ env.GCR_REGISTRY }}

      - name: Push to GCR (staging-fastlane tag)
        run: |
          # Tag with fast-lane marker (UNTESTED)
          docker tag ${{ env.IMAGE_NAME }}:fastlane-staging ${{ env.GCR_IMAGE }}:staging-fastlane-untested
          docker tag ${{ env.IMAGE_NAME }}:fastlane-staging ${{ env.GCR_IMAGE }}:staging-fastlane-untested-${{ github.sha }}

          # Push to GCR
          docker push ${{ env.GCR_IMAGE }}:staging-fastlane-untested
          docker push ${{ env.GCR_IMAGE }}:staging-fastlane-untested-${{ github.sha }}

          echo "âœ… Fast-lane image pushed to GCR" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Tags: staging-fastlane-untested, staging-fastlane-untested-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Cache: Isolated (scope=fastlane)" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **UNTESTED** - no test suite ran on this image" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to Cloud Run (staging)
        uses: ./.github/actions/deploy-cloudrun
        with:
          environment: staging
          image_tag: staging-fastlane-untested
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Fast-lane summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš¡ Fast-Lane Deployment Complete (UNTESTED)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**What happened:**" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Built image **without running tests** (fast)" >> $GITHUB_STEP_SUMMARY
          echo "- Pushed to GCR with \`staging-fastlane-untested\` tag" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed to staging environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Safety guarantees:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Separate cache (scope=fastlane - won't pollute main CI)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Separate GCR tags (staging-fastlane-untested)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Only affects staging environment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Master/production will NEVER use this untested image" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Main CI cache remains clean and tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ WARNING: Image is UNTESTED**" >> $GITHUB_STEP_SUMMARY
          echo "- No unit tests ran" >> $GITHUB_STEP_SUMMARY
          echo "- No integration tests ran" >> $GITHUB_STEP_SUMMARY
          echo "- No security scans ran" >> $GITHUB_STEP_SUMMARY
          echo "- Use only for trivial fixes (typos, logging, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps for proper release:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Commit without 'skip' to run full CI with tests" >> $GITHUB_STEP_SUMMARY
          echo "2. Merge to master for candidate deployment" >> $GITHUB_STEP_SUMMARY
          echo "3. Tag for production release" >> $GITHUB_STEP_SUMMARY
