name: Backend CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend_easy/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend_easy/**'
      - '.github/workflows/backend-ci.yml'

env:
  PYTHON_VERSION: '3.10'
  DJANGO_SETTINGS_MODULE: bus_kiosk_backend.test_settings

jobs:
  # Quality Gates
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend_easy/app/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend_easy
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-cov pytest-django pytest-xdist bandit safety

      - name: Run pre-commit hooks
        uses: pre-commit/action@v3.0.0
        with:
          extra_args: --all-files --verbose

      - name: Security scan with Bandit
        run: |
          cd backend_easy
          bandit -r app/ -f json -o security-report.json || true
          bandit -r app/ --exit-zero

      - name: Security scan with Safety
        run: |
          cd backend_easy
          safety check --output json || true

  # Testing Pipeline
  test:
    runs-on: ubuntu-latest
    needs: quality-check
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend_easy
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-cov pytest-django pytest-xdist coverage[toml]

      - name: Run Django migrations
        run: |
          cd backend_easy/app
          python manage.py migrate --settings=bus_kiosk_backend.test_settings

      - name: Run tests with coverage
        run: |
          cd backend_easy
          python -m pytest app/tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under=85 \
            --junitxml=test-results.xml \
            -v \
            --tb=short

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend_easy/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: backend_easy/test-results.xml

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: backend_easy/htmlcov/

  # Integration Tests
  integration-test:
    runs-on: ubuntu-latest
    needs: test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend_easy
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-django pytest-xdist

      - name: Run integration tests
        run: |
          cd backend_easy
          python -m pytest app/tests/integration/ \
            --junitxml=integration-results.xml \
            -v \
            --tb=short \
            --maxfail=5

      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-results
          path: backend_easy/integration-results.xml

  # Performance Tests
  performance-test:
    runs-on: ubuntu-latest
    needs: integration-test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend_easy
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-benchmark locust

      - name: Run performance tests
        run: |
          cd backend_easy
          python -m pytest app/tests/ \
            -k "performance or benchmark" \
            --benchmark-only \
            --benchmark-json=benchmark-results.json \
            -v

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-results
          path: backend_easy/benchmark-results.json

  # Deployment (only on main branch)
  deploy:
    runs-on: ubuntu-latest
    needs: [quality-check, test, integration-test, performance-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: imperial-easypool-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend_easy
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster imperial-easypool-cluster \
            --service imperial-easypool-backend-service \
            --force-new-deployment \
            --region us-east-1

      - name: Run database migrations
        run: |
          aws ecs run-task \
            --cluster imperial-easypool-cluster \
            --task-definition imperial-easypool-migration-task \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[subnet-12345,subnet-67890],securityGroups=[sg-12345]}" \
            --region us-east-1

  # Rollback on failure
  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Rollback deployment
        run: |
          aws ecs update-service \
            --cluster imperial-easypool-cluster \
            --service imperial-easypool-backend-service \
            --task-definition imperial-easypool-backend-stable \
            --region us-east-1