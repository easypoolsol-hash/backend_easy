name: CI Pipeline

on:
  push:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: bus_kiosk_backend

jobs:
  # Job 1: Fast Quality Checks (Fail Fast)
  quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,testing]

    - name: Run quality checks (fail fast)
      run: |
        ruff check --fix . || exit 1
        PYTHONPATH=$PWD python -m mypy . --no-incremental || exit 1

  # Job 2: Unit Tests (Fast Feedback)
  unit-tests:
    runs-on: ubuntu-latest
    needs: quality
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,testing]

    - name: Run migrations
      run: python app/manage.py migrate --noinput
      env:
        DEBUG: true
        SECRET_KEY: test-secret-key-for-testing-only
        ENCRYPTION_KEY: test-32-byte-encryption-key-for-testing
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        REDIS_URL: redis://localhost:6379/0

    - name: Run unit tests (fast)
      run: |
        python -m pytest tests/unit/ -v --tb=short \
          --cov=app/kiosks --cov=app/buses --cov=app/students --cov=app/events --cov=app/users --cov=app/bus_kiosk_backend \
          --cov-config=.coveragerc \
          --cov-report=xml:build/coverage.xml \
          --cov-report=term-missing \
          --cov-fail-under=80 \
          -n auto \
          --dist worksteal
      env:
        DEBUG: true
        SECRET_KEY: test-secret-key-for-testing-only
        ENCRYPTION_KEY: test-32-byte-encryption-key-for-testing
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        REDIS_URL: redis://localhost:6379/0
        CELERY_BROKER_URL: redis://localhost:6379/0
        CELERY_RESULT_BACKEND: redis://localhost:6379/0

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./build/coverage.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  # Job 3: Integration Tests (Parallel with unit tests)
  integration-tests:
    runs-on: ubuntu-latest
    needs: quality  # Can run in parallel with unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,testing]

    - name: Run migrations
      run: python app/manage.py migrate --noinput
      env:
        DEBUG: true
        SECRET_KEY: test-secret-key-for-testing-only
        ENCRYPTION_KEY: test-32-byte-encryption-key-for-testing
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        REDIS_URL: redis://localhost:6379/0

    - name: Run integration tests
      run: |
        python -m pytest tests/integration/ -v --tb=short \
          --maxfail=3 \
          --durations=10
      env:
        DEBUG: true
        SECRET_KEY: test-secret-key-for-testing-only
        ENCRYPTION_KEY: test-32-byte-encryption-key-for-testing
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        REDIS_URL: redis://localhost:6379/0
        CELERY_BROKER_URL: redis://localhost:6379/0
        CELERY_RESULT_BACKEND: redis://localhost:6379/0

  # Job 4: API Contract Tests (Parallel with integration)
  contract-tests:
    runs-on: ubuntu-latest
    needs: quality  # Can run in parallel with unit-tests and integration-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,testing]

    - name: Run migrations
      run: python app/manage.py migrate --noinput
      env:
        DEBUG: true
        SECRET_KEY: test-secret-key-for-testing-only
        ENCRYPTION_KEY: test-32-byte-encryption-key-for-testing
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432

    - name: Run API contract tests
      run: |
        python -m pytest tests/ -k "schemathesis or contract" -v --tb=short \
          --maxfail=3
      env:
        DEBUG: true
        SECRET_KEY: test-secret-key-for-testing-only
        ENCRYPTION_KEY: test-32-byte-encryption-key-for-testing
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432

  # Job 5: Build Docker Image (starts early)
  build:
    runs-on: ubuntu-latest
    needs: unit-tests  # Only needs unit tests to pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        export DOCKER_BUILDKIT=1
        IMAGE_TAG=${{ secrets.DOCKER_USERNAME || 'testuser' }}/bus_kiosk_backend:test
        docker build --target runtime --tag "$IMAGE_TAG" --build-arg BUILDKIT_INLINE_CACHE=1 --progress=plain .

    - name: Save Docker image
      run: docker save ${{ secrets.DOCKER_USERNAME || 'testuser' }}/${IMAGE_NAME}:test -o /tmp/image.tar

    - name: Upload image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: /tmp/image.tar
        retention-days: 1

  # Job 6: Test Docker Image (PROPER HTTP TEST - Fixes 502!)
  test-image:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download image artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: /tmp

    - name: Load Docker image
      run: docker load --input /tmp/image.tar

    - name: Test Docker image HTTP serving (FAIL FAST!)
      run: |
        # Start the application container
        docker run -d --name test-app \
          -e DEBUG=false \
          -e SECRET_KEY=test-secret-key \
          -e DB_ENGINE=django.db.backends.sqlite3 \
          -e DB_NAME=/tmp/test.db \
          -e ALLOWED_HOSTS=localhost,127.0.0.1 \
          -p 8000:8000 \
          ${{ secrets.DOCKER_USERNAME || 'testuser' }}/${{ env.IMAGE_NAME }}:test

        # Wait for app to start (fail fast if it doesn't)
        echo "Waiting for Django app to start..."
        for i in {1..30}; do
          if curl -f -s http://localhost:8000/health/ > /dev/null 2>&1; then
            echo "‚úÖ Django app is responding!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "‚ùå Django app failed to start - logs:"
            docker logs test-app
            docker stop test-app
            exit 1
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

        # Test critical endpoints
        echo "Testing critical endpoints..."
        curl -f http://localhost:8000/health/ || (docker logs test-app && exit 1)
        curl -f http://localhost:8000/api/schema/ || (docker logs test-app && exit 1)

        # Cleanup
        docker stop test-app
        echo "‚úÖ Docker image test passed!"

  # Job 7: Security Scan
  security:
    runs-on: ubuntu-latest
    needs: test-image

    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download image artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: /tmp

    - name: Load Docker image
      run: docker load --input /tmp/image.tar

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.DOCKER_USERNAME || 'testuser' }}/${{ env.IMAGE_NAME }}:test
        format: 'table'

  # Job 8: Push to Docker Hub (master/main only)
  push:
    runs-on: ubuntu-latest
    needs: [test-image, security]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download image artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: /tmp

    - name: Load Docker image
      run: docker load --input /tmp/image.tar

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Tag and push images
      run: |
        docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:test \
          ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

        docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:test \
          ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

        docker push ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Output image information
      run: |
        echo "üéâ CI Pipeline Complete!"
        echo "‚úÖ All tests passed"
        echo "üì¶ Images pushed:"
        echo "   ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "   ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo ""
        echo "üöÄ Ready for CD deployment"
