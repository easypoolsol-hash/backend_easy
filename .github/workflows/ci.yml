name: Unified CI/CD Pipeline

on:
  push:
    branches: [ develop, staging, production ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: read
  packages: write
  id-token: write

env:
  IMAGE_NAME: backend_easy
  GCR_IMAGE: asia-south1-docker.pkg.dev/easypool-backend/backend-repo/backend_easy

jobs:
  # ============================================================================
  # SINGLE UNIFIED FLOW
  # ============================================================================
  # 1. Detect branch (develop/staging/production)
  # 2. Quality checks + Tests (parallel - same for all)
  # 3. Build image (with cache - fast rebuild, fresh every time)
  # 4. Security scan + Smoke tests (parallel)
  # 5. Deploy to detected environment
  # ============================================================================

  # STEP 1: Detect active branch
  detect-environment:
    name: ðŸŽ¯ Detect Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      deploy_target: ${{ steps.detect.outputs.deploy_target }}
    steps:
      - name: Detect branch and environment
        id: detect
        run: |
          BRANCH="${{ github.ref_name }}"

          echo "## ðŸŽ¯ Active Branch: **$BRANCH**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "$BRANCH" in
            develop)
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "deploy_target=dev" >> $GITHUB_OUTPUT
              echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
              ;;
            staging)
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "deploy_target=staging" >> $GITHUB_OUTPUT
              echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
              ;;
            production)
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "deploy_target=production" >> $GITHUB_OUTPUT
              echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "âŒ Unknown branch: $BRANCH" >> $GITHUB_STEP_SUMMARY
              exit 1
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Flow:**" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Quality + Tests (parallel)" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ—ï¸ Build image (cached)" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ”’ Security + Smoke (parallel)" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸš€ Deploy to $BRANCH" >> $GITHUB_STEP_SUMMARY

  # STEP 2: Quality checks
  quality:
    name: âœ… Quality (lint + mypy)
    runs-on: ubuntu-latest
    needs: [detect-environment]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-quality-checks

  # STEP 2: Tests (parallel matrix)
  tests:
    name: ðŸ§ª Tests (${{ matrix.test-type }})
    runs-on: ubuntu-latest
    needs: [detect-environment]
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, contract]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-tests
        with:
          test_type: ${{ matrix.test-type }}
          image_name: ${{ env.IMAGE_NAME }}

  # STEP 3: Build image (fresh build every time, but with cache for speed)
  build:
    name: ðŸ—ï¸ Build Image
    runs-on: ubuntu-latest
    needs: [detect-environment, quality, tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ needs.detect-environment.outputs.environment }}
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save image to artifact
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ needs.detect-environment.outputs.environment }} | gzip > /tmp/image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar.gz
          retention-days: 1

  # STEP 4a: Security scan (parallel with smoke tests)
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [detect-environment, build]
    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: docker load < /tmp/image.tar.gz

      - uses: ./.github/actions/run-security-scan
        with:
          image_name: ${{ env.IMAGE_NAME }}

  # STEP 4b: Smoke tests (parallel with security)
  smoke-tests:
    name: ðŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [detect-environment, build]
    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: docker load < /tmp/image.tar.gz

      - uses: ./.github/actions/run-smoke-test
        with:
          image_name: ${{ env.IMAGE_NAME }}

  # STEP 5: Deploy to environment (branch-specific)
  deploy:
    name: ðŸš€ Deploy to ${{ needs.detect-environment.outputs.deploy_target }}
    runs-on: ubuntu-latest
    needs: [detect-environment, build, security, smoke-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: docker load < /tmp/image.tar.gz

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker asia-south1-docker.pkg.dev

      - name: Tag and push image
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"

          # Tag with environment and SHA
          docker tag ${{ env.IMAGE_NAME }}:$ENV ${{ env.GCR_IMAGE }}:$ENV
          docker tag ${{ env.IMAGE_NAME }}:$ENV ${{ env.GCR_IMAGE }}:$ENV-${{ github.sha }}

          # Tag production with version tag if production branch
          if [ "$ENV" = "production" ]; then
            docker tag ${{ env.IMAGE_NAME }}:$ENV ${{ env.GCR_IMAGE }}:latest
          fi

          # Push all tags
          docker push ${{ env.GCR_IMAGE }}:$ENV
          docker push ${{ env.GCR_IMAGE }}:$ENV-${{ github.sha }}

          if [ "$ENV" = "production" ]; then
            docker push ${{ env.GCR_IMAGE }}:latest
          fi

          echo "## ðŸ“¦ Pushed Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.GCR_IMAGE }}:$ENV\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.GCR_IMAGE }}:$ENV-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "$ENV" = "production" ]; then
            echo "- \`${{ env.GCR_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          fi

      - uses: ./.github/actions/deploy-cloudrun
        with:
          environment: ${{ needs.detect-environment.outputs.environment }}
          image_tag: ${{ needs.detect-environment.outputs.environment }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deployment summary
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** easypool-backend-$ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** asia-south1 (Mumbai)" >> $GITHUB_STEP_SUMMARY
