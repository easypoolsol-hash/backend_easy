name: Deploy to Cloud Run
description: Deploy a specific image tag to Cloud Run (Terraform manages all configuration)

inputs:
  environment:
    description: 'Environment to deploy (staging, candidate, production)'
    required: true
  image_tag:
    description: 'Image tag to deploy'
    required: true
  workload_identity_provider:
    description: 'GCP Workload Identity Provider'
    required: true
  service_account:
    description: 'GCP Service Account'
    required: true

runs:
  using: composite
  steps:
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ inputs.workload_identity_provider }}
        service_account: ${{ inputs.service_account }}

    - name: Deploy to Cloud Run
      shell: bash
      run: |
        # Map environment to service name (matches Terraform config)
        case "${{ inputs.environment }}" in
          dev)
            SERVICE_NAME="easypool-backend-dev"
            ;;
          staging)
            SERVICE_NAME="easypool-backend-staging"
            ;;
          production)
            SERVICE_NAME="easypool-backend"
            ;;
          *)
            echo "âŒ Invalid environment: ${{ inputs.environment }}"
            exit 1
            ;;
        esac

        echo "ðŸš€ Deploying to ${{ inputs.environment }}..."
        echo "ðŸ“¦ Image: asia-south1-docker.pkg.dev/backend-easypool/backend-repo/backend_easy:${{ inputs.image_tag }}"
        echo "ðŸŽ¯ Service: $SERVICE_NAME"
        echo "ðŸ“ Git SHA: ${{ github.sha }}"

        # Prepare traceability metadata
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        DEPLOYED_AT=$(date +%s)

        # Deploy with full traceability metadata (Fortune 500 pattern)
        # Terraform controls infrastructure, CI/CD adds deployment metadata
        gcloud run deploy $SERVICE_NAME \
          --image=asia-south1-docker.pkg.dev/backend-easypool/backend-repo/backend_easy:${{ inputs.image_tag }} \
          --region=asia-south1 \
          --platform=managed \
          --update-labels=git-sha=${SHORT_SHA},deployed-at=${DEPLOYED_AT},env=${{ inputs.environment }} \
          --update-annotations=git-commit=${{ github.sha }},git-branch=${{ github.ref_name }},deployed-by=github-actions \
          --quiet

        # Get service URL
        SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=asia-south1 --format='value(status.url)')

        echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Service:** $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Traceability" >> $GITHUB_STEP_SUMMARY
        echo "**Git Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Git Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Short SHA:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed At:** ${DEPLOYED_AT} (Unix timestamp)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ Infrastructure managed by Terraform, deployment metadata by CI/CD!" >> $GITHUB_STEP_SUMMARY

        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
