# Pre-commit hooks for backend API
# Industry standard: Auto-regenerate OpenAPI schema on code changes
# Used by: Google, Netflix, Stripe, Uber

repos:
  # Local hooks (run in this repo)
  # All hooks use language: python and will run in project venv
  - repo: local
    hooks:
      # OpenAPI Schema Regeneration (CRITICAL - Zero Drift Policy)
      # Only runs when API-related files change (views, serializers, urls)
      # Environment variables loaded automatically by run_in_venv.sh from .env.test
      - id: openapi-schema
        name: Regenerate OpenAPI Schema
        entry: bash
        args: ["scripts/run_in_venv.sh", "app/manage.py", "spectacular", "--file", "openapi-schema.yaml"]
        language: system
        pass_filenames: false
        stages: [commit]
        always_run: false
        files: (views|serializers|urls|models)\.py$
        types: [python]
        verbose: true

      # Copy schema to Flutter projects (keeps frontends in sync)
      # Only runs when schema file changes
      - id: copy-schema-to-flutter
        name: Copy OpenAPI Schema to Flutter
        entry: powershell
        args: ["-Command", "Copy-Item openapi-schema.yaml ../bus_kiosk_easy/bus_kiok/openapi-schema.yaml -Force; Copy-Item openapi-schema.yaml ../frontend_easy/openapi-schema.yaml -Force"]
        language: system
        pass_filenames: false
        stages: [commit]
        always_run: false
        files: openapi-schema\.yaml$
        require_serial: true
        verbose: true

      # Regenerate Bus Kiosk Flutter API client (enforces zero drift)
      # CONSTITUTIONAL: Generates to packages/ (industry standard location)
      # SERIALIZATION: Uses json_serializable with null-aware-elements (stable in 2025, Dart 3.5+)
      # BEST PRACTICE 2025: Use dart run instead of flutter pub run (deprecated)
      # Only runs when schema file changes
      - id: regenerate-bus-kiosk-api
        name: Regenerate Bus Kiosk API Client
        entry: powershell
        args: ["-Command", "cd ../bus_kiosk_easy; npx @openapitools/openapi-generator-cli generate -i bus_kiok/openapi-schema.yaml -g dart-dio -o packages/bus_kiosk_api --additional-properties=pubName=bus_kiosk_api,useEnumExtension=true,serializationLibrary=json_serializable; cd packages/bus_kiosk_api; flutter pub get; dart run build_runner build --delete-conflicting-outputs"]
        language: system
        pass_filenames: false
        stages: [commit]
        always_run: false
        files: openapi-schema\.yaml$
        require_serial: true
        verbose: true

      # Regenerate Frontend Easy API client (enforces zero drift for web/mobile dashboards)
      # MATCHES bus_kiosk pattern exactly - dart-dio generator with json_serializable
      # Only runs when schema file changes
      - id: regenerate-frontend-easy-api
        name: Regenerate Frontend Easy API Client
        entry: powershell
        args: ["-Command", "cd ../frontend_easy; npx @openapitools/openapi-generator-cli generate -i openapi-schema.yaml -g dart-dio -o packages/frontend_easy_api --additional-properties=pubName=frontend_easy_api,useEnumExtension=true,serializationLibrary=json_serializable; (Get-Content packages/frontend_easy_api/pubspec.yaml) -replace \"sdk: '>=[^']+'\", \"sdk: '>=3.9.0 <4.0.0'\" | Set-Content packages/frontend_easy_api/pubspec.yaml; cd packages/frontend_easy_api; flutter pub get; dart run build_runner build --delete-conflicting-outputs"]
        language: system
        pass_filenames: false
        stages: [commit]
        always_run: false
        files: openapi-schema\.yaml$
        require_serial: true
        verbose: true

      # Constitutional API Drift Validator (uses industry tool: openapi-diff)
      # Runs when API code or schema changes
      - id: validate-api-drift
        name: Validate API Drift (Zero-Drift Guarantee)
        entry: bash
        args: ["scripts/check_api_drift.sh"]
        language: system
        pass_filenames: false
        stages: [commit]
        always_run: false
        files: (views|serializers|urls|models|openapi-schema)\.py$|openapi-schema\.yaml$
        verbose: true

      # Snapshot Contract Sync (same pattern as OpenAPI)
      - id: copy-snapshot-contract
        name: Copy Snapshot Contract to Frontend
        entry: powershell
        args: ["-Command", "New-Item -ItemType Directory -Force -Path '../bus_kiosk_easy/imperial_governance/constitutional_core/contracts' | Out-Null; Copy-Item imperial_governance/constitutional_core/contracts/snapshot_interface_contract.yaml ../bus_kiosk_easy/imperial_governance/constitutional_core/contracts/snapshot_interface_contract.yaml -Force"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: snapshot_interface_contract\.yaml
        verbose: true

      # Validate Snapshot Contract Compliance
      - id: validate-snapshot-contract
        name: Validate Snapshot Contract
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/test_snapshot_generator.py", "-v", "--tb=short"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (kiosks/services\.py|snapshot_interface_contract\.yaml)
        verbose: true

      # Run unit tests when core logic changes (fast feedback)
      - id: unit-tests-core
        name: Unit Tests (Core Logic)
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/", "-v", "--tb=short", "--maxfail=3"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (app/(users|buses|students|kiosks|events)/.*\.py|tests/unit/.*\.py)
        verbose: true

      # Run authentication tests when auth code changes
      - id: auth-tests
        name: Auth Tests (Security Critical)
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/test_kiosk_auth.py", "tests/integration/test_authentication_flow.py", "-v", "--tb=short"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (app/(users|kiosks)/.*\.py|tests/.*auth.*\.py)
        verbose: true

      # Run ML/face recognition tests when ML code changes
      - id: ml-tests
        name: ML Tests (Face Recognition)
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/test_face_embedding.py", "tests/integration/test_face_embedding_integration.py", "-v", "--tb=short"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (app/.*embed.*\.py|tests/.*face.*\.py|tests/.*embed.*\.py)
        verbose: true

  # Additional fast/modern hooks (consolidated from config/ into root)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
        args: ['--maxkb=15000']  # Allow up to 15MB (for ML model files)
      - id: check-merge-conflict
      - id: debug-statements

  # Ruff - fast linter/formatter replacement for flake8/isort
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.13.3
    hooks:
      - id: ruff
        args: [--fix]  # Auto-fix
        files: \.py$
      - id: ruff-format
        files: \.py$

  # Black - DISABLED: conflicts with ruff-format
  # - repo: https://github.com/psf/black
  #   rev: 24.8.0
  #   hooks:
  #     - id: black
  #       language_version: python3.10

  # Type checking - matches CI configuration
  # Uses virtual environment Python for consistent local/CI testing
  - repo: local
    hooks:
      - id: mypy
        name: mypy (full project check)
        entry: bash
        language: system
        pass_filenames: false  # Run on whole project, not per-file
        args: ["-c", "export PYTHONPATH=app && bash scripts/run_in_venv.sh -m mypy app --no-incremental"]
        types: [python]
        stages: [commit]
        verbose: true

  # Pylint - DISABLED: version incompatibility with pylint-django
  # - repo: local
  #   hooks:
  #     - id: pylint
  #       name: pylint
  #       entry: pylint
  #       language: system
  #       files: \.py$
  #       args: [bus_kiosk_backend, buses, events, kiosks, students, users, --errors-only]
  #       pass_filenames: false

  # Security scanning (optional)
  - repo: local
    hooks:
      - id: bandit
        name: bandit (security scanner)
        entry: bash
        args: ["-c", "bash scripts/run_in_venv.sh -m bandit -r app -x '**/test*' -c pyproject.toml -f txt 2>/dev/null || echo '⚠️ Bandit not installed, skipping security scan'"]
        language: system
        files: \.py$
        exclude: ^.*(?:test|generated|migrations).*\.py$
        pass_filenames: false

  # Test runner (optional) - DISABLED: replaced with targeted test hooks above
  # The hooks above run specific tests only when relevant files change,
  # providing fast feedback without slowing down all commits.
  # - repo: local
  #   hooks:
  #     - id: pytest
  #       name: pytest
  #       entry: python -m pytest
  #       language: system
  #       pass_filenames: false
  #       args: ["app/tests/unit/", "--tb=short", "--maxfail=3"]
  #       files: ^(app/.*\.py|tests/.*\.py)$
  #       types: [python]
