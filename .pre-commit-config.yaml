# Pre-commit hooks for backend API
# Industry standard: Auto-regenerate OpenAPI schema on code changes
# Used by: Google, Netflix, Stripe, Uber

repos:
  # Local hooks (run in this repo)
  # All hooks use language: python and will run in project venv
  - repo: local
    hooks:
      # OpenAPI Schema Regeneration
      # Industry standard: Backend generates spec, frontend uses manually
      - id: openapi-schema
        name: Regenerate OpenAPI Schema
        entry: bash
        args: ["scripts/run_in_venv.sh", "app/manage.py", "spectacular", "--file", "openapi-schema.yaml"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (views|serializers|urls|models)\.py$
        types: [python]
        verbose: true

      # Constitutional API Drift Validator (uses industry tool: openapi-diff)
      # Runs when API code or schema changes
      - id: validate-api-drift
        name: Validate API Drift (Zero-Drift Guarantee)
        entry: bash
        args: ["scripts/check_api_drift.sh"]
        language: system
        pass_filenames: false
        stages: [commit]
        always_run: false
        files: (views|serializers|urls|models|openapi-schema)\.py$|openapi-schema\.yaml$
        verbose: true

      # Validate Snapshot Contract Compliance
      - id: validate-snapshot-contract
        name: Validate Snapshot Contract
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/test_snapshot_generator.py", "-v", "--tb=short"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (kiosks/services\.py|snapshot_interface_contract\.yaml)
        verbose: true

      # Run unit tests when core logic changes (fast feedback)
      - id: unit-tests-core
        name: Unit Tests (Core Logic)
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/", "-v", "--tb=short", "--maxfail=3"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (app/(users|buses|students|kiosks|events)/.*\.py|tests/unit/.*\.py)
        verbose: true

      # Run authentication tests when auth code changes
      - id: auth-tests
        name: Auth Tests (Security Critical)
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/integration/test_authentication_flow.py", "-v", "--tb=short"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (app/(users|kiosks)/.*\.py|tests/.*auth.*\.py)
        verbose: true

      # Run ML/face recognition tests when ML code changes
      - id: ml-tests
        name: ML Tests (Face Recognition)
        entry: bash
        args: ["scripts/run_in_venv.sh", "-m", "pytest", "tests/unit/test_face_embedding.py", "tests/integration/test_face_embedding_integration.py", "-v", "--tb=short"]
        language: system
        pass_filenames: false
        stages: [commit]
        files: (app/.*embed.*\.py|tests/.*face.*\.py|tests/.*embed.*\.py)
        verbose: true

  # Additional fast/modern hooks (consolidated from config/ into root)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
        args: ['--maxkb=15000']  # Allow up to 15MB (for ML model files)
      - id: check-merge-conflict
      - id: debug-statements

  # Ruff - fast linter/formatter replacement for flake8/isort
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.13.3
    hooks:
      - id: ruff
        args: [--fix]  # Auto-fix
        files: \.py$
      - id: ruff-format
        files: \.py$

  # Black - DISABLED: conflicts with ruff-format
  # - repo: https://github.com/psf/black
  #   rev: 24.8.0
  #   hooks:
  #     - id: black
  #       language_version: python3.10

  # Type checking - matches CI configuration
  # Uses virtual environment Python for consistent local/CI testing
  - repo: local
    hooks:
      - id: mypy
        name: mypy (full project check)
        entry: bash
        language: system
        pass_filenames: false  # Run on whole project, not per-file
        args: ["-c", "export PYTHONPATH=app && bash scripts/run_in_venv.sh -m mypy app --no-incremental"]
        types: [python]
        stages: [commit]
        verbose: true

  # Pylint - DISABLED: version incompatibility with pylint-django
  # - repo: local
  #   hooks:
  #     - id: pylint
  #       name: pylint
  #       entry: pylint
  #       language: system
  #       files: \.py$
  #       args: [bus_kiosk_backend, buses, events, kiosks, students, users, --errors-only]
  #       pass_filenames: false

  # Security scanning (optional)
  - repo: local
    hooks:
      - id: bandit
        name: bandit (security scanner)
        entry: bash
        args: ["-c", "bash scripts/run_in_venv.sh -m bandit -r app -x '**/test*' -c pyproject.toml -f txt 2>/dev/null || echo '⚠️ Bandit not installed, skipping security scan'"]
        language: system
        files: \.py$
        exclude: ^.*(?:test|generated|migrations).*\.py$
        pass_filenames: false

  # Test runner (optional) - DISABLED: replaced with targeted test hooks above
  # The hooks above run specific tests only when relevant files change,
  # providing fast feedback without slowing down all commits.
  # - repo: local
  #   hooks:
  #     - id: pytest
  #       name: pytest
  #       entry: python -m pytest
  #       language: system
  #       pass_filenames: false
  #       args: ["app/tests/unit/", "--tb=short", "--maxfail=3"]
  #       files: ^(app/.*\.py|tests/.*\.py)$
  #       types: [python]
